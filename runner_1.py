import os
import joblib
import pandas as pd
import numpy as np
import warnings
import subprocess
import time


#to be merged with SriSai Code

loaded_model=joblib.load("model_1.pkl")#model_1.pkl location
feature_pred_array=list()

real_data=pd.read_csv(hello1)
#CIC flowmeter converted csv

rem=real_data[['Flow IAT Max','Bwd Pkts/s','Fwd Pkt Len Mean',
               'Subflow Fwd Byts','Pkt Size Avg','Fwd Pkt Len Max',
               'TotLen Fwd Pkts','PSH Flag Cnt','Fwd Seg Size Avg',
               'Flow Duration','Init Fwd Win Byts']]
feature_pred_array=list()
for i,r in rem.iterrows():
    fet1=list()

    fet1.append(r['Flow IAT Max'])
    fet1.append(r['Bwd Pkts/s'])
    fet1.append(r['Fwd Pkt Len Mean'])
    fet1.append(r['Subflow Fwd Byts'])
    fet1.append(r['Pkt Size Avg'])
    fet1.append(r['Fwd Pkt Len Max'])
    fet1.append(r['TotLen Fwd Pkts'])
    fet1.append(r['PSH Flag Cnt'])
    fet1.append(r['Fwd Seg Size Avg'])
    fet1.append(r['Flow Duration'])
    fet1.append(r['Init Fwd Win Byts'])


    feature_pred_array.append(fet1)
    array_pred = np.array(feature_pred_array)

mal=0
try:
    count1=0
    for i in loaded_model.predict(array_pred):
        if i==1:
            count1+=1
            if count1==3:# minimum 3 packets in the csv have to be flagged (having more PSH ON packets might result in this)
                mal=2
except:
    pass 


#this is another section
current_directory1 = os.path.dirname(os.path.abspath(__file__))
print(current_directory1)

wireshark_folder = find_wireshark_folder()
os.chdir(wireshark_folder)


output_file_path = os.path.join(current_directory1, 'smthg.csv')
# Specify the tshark command
    
tshark_command = f'tshark -r {hello} -Y "tcp" -T fields -e tcp.window_size_value -e tcp.completeness.str > {output_file_path}'

# Execute the tshark command using subprocess
try:
    subprocess.run(tshark_command, shell=True, check=True)
    print("tshark command executed successfully.")
except subprocess.CalledProcessError as e:
    print(f"Error executing tshark command: {e}")


current_directory = os.getcwd()
csv_file_relative_path = 'smthg.csv'
csv_file_path = os.path.join(current_directory, csv_file_relative_path)
os.chdir(current_directory)
df=pd.read_csv(csv_file_path)

first_column=df.columns[0]

df = df.rename(columns={first_column: 'window'})

df[['window_size', 'comp_str']] = df['window'].str.split('\t', expand=True)
df.drop('window', axis=1, inplace=True)

df['window_size'] = pd.to_numeric(df['window_size'], errors='coerce').astype('Int64')


for index, row in df.iterrows():
    if row['window_size'] == 513:
        if row['comp_str'] == "路F路ASS":
            mal=1
            break
    
    elif row['window_size'] == 256:
        if row['comp_str'] == "路F路ASS":
            mal=1
            break

    elif row['window_size'] == 1024:
        mal=1
        break


if mal==1:
    print("A portscan has been attempted on your system!!!")
elif mal==2:
    print("Mostly normal network activity, however Our AI/ML modal suspects a small scale PortScan activity in ur network.")
else:
    print("Perfectly Normal Network Activity, Happy Networking!!")

